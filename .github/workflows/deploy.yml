name: Deploy to EKS

on:
  workflow_dispatch:  # allows manual debugging
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: "ca-central-1"
  EKS_CLUSTER_NAME: "prod-oidc-cluster"

jobs:

  debug-oidc:
    name: Debug OIDC Token
    runs-on: ubuntu-latest
    steps:
      - name: Dump OIDC Claims
        run: |
          echo "REQUESTING OIDC TOKEN..."
          TOKEN_JSON=$(curl -sSf -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=sts.amazonaws.com")

          JWT=$(echo "$TOKEN_JSON" | jq -r .value)

          echo "ðŸ”¹ SUB claim:"
          echo "$JWT" | cut -d '.' -f2 | base64 -d 2>/dev/null | jq -r .sub

          echo "ðŸ”¹ AUD claim:"
          echo "$JWT" | cut -d '.' -f2 | base64 -d 2>/dev/null | jq -r .aud

          echo "ðŸ”¹ GITHUB_REF:"
          echo "$GITHUB_REF"


